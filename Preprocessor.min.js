/*
 Preprocessor.js (c) 2013 Daniel Wirtz <dcode@dcode.io>
 Released under the Apache License, Version 2.0
 see: https://github.com/dcodeIO/Preprocessor.js for details
*/
var j=null;
(function(k){function a(a,c){this.source=""+a;this.g=c||".";this.h=("undefined"==typeof window||!window.window)&&"function"==typeof require;this.c=50}a.a=/([ ]*)\/\/[ ]+#(include|ifn?def|if|endif|else|elif|put)/g;a.e=/include[ ]+"([^"\\]*(\\.[^"\\]*)*)"[ ]*\r?\n/g;a.d=/(ifdef|ifndef|if)[ ]*([^\r\n]+)\r?\n/g;a.b=/(endif|else|elif)([ ]+[^\r\n]+)?\r?\n/g;a.f=/put[ ]+([^\n]+)[ ]*/g;a.stripSlashes=function(a){return(a+"").replace(/\\(.?)/g,function(a,b){switch(b){case "\\":return"\\";case "0":return"\x00";case "":return"";
default:return b}})};a.addSlashes=function(a){return(a+"").replace(/([\\"'])/g,"\\$1").replace(/\0/g,"\\0")};a.indent=function(a,c){for(var b=a.split("\n"),d=0;d<b.length;d++)b[d]=c+b[d];return b.join("\n")};a.nlToStr=function(a){return"["+a.replace(/\r/g,"").replace(/\n/g,"\\n")+"]"};a.evaluate=function(h,c){var b=a.addSlashes;return function(a,c){for(var g in a)a.hasOwnProperty(g)&&eval("var "+g+' = "'+b(""+a[g])+'";');return eval(c)}.call(j,h,c)};a.prototype.process=function(h,c){h=h||{};c="function"==
typeof c?c:function(){};c("Defines: "+JSON.stringify(h));for(var b,d,e,g=[];(b=a.a.exec(this.source))!==j;){c(b[2]+" @ "+b.index+"-"+a.a.lastIndex);var f=b[1];switch(b[2]){case "include":if(!this.h)throw Error("The #include directive requires Preprocessor.js to be run in node.js");a.e.lastIndex=b.index;if((d=a.e.exec(this.source))===j)throw Error("Illegal #"+b[2]+": "+this.source.substring(b.index,b.index+this.c)+"...");e=a.stripSlashes(d[1]);c("  incl: "+e);try{e=require("fs").readFileSync(this.g+
"/"+e)+"",this.source=this.source.substring(0,b.index)+a.indent(e,f)+this.source.substring(a.e.lastIndex)}catch(k){throw Error("File not found: "+e+" ("+k+")");}a.a.lastIndex=0<g.length?g[g.length-1].lastIndex:0;c("  continue at "+a.a.lastIndex);break;case "put":a.f.lastIndex=b.index;if((d=a.f.exec(this.source))===j)throw Error("Illegal #"+b[2]+": "+this.source.substring(b.index,b.index+this.c)+"...");e=d[1];c("  expr: "+d[1]);e=a.evaluate(h,d[1]);c("  value: "+a.nlToStr(e));this.source=this.source.substring(0,
b.index)+f+e+this.source.substring(a.f.lastIndex);a.a.lastIndex=b.index+e.length;c("  continue at "+a.a.lastIndex);break;case "ifdef":case "ifndef":case "if":a.d.lastIndex=b.index;if((d=a.d.exec(this.source))===j)throw Error("Illegal #"+b[2]+": "+this.source.substring(b.index,b.index+this.c)+"...");c("  test: "+d[2]);e="ifdef"==d[1]?!!h[d[2]]:"ifndef"==d[1]?!h[d[2]]:a.evaluate(h,d[2]);c("  value: "+e);g.push(b={include:e,index:b.index,lastIndex:a.d.lastIndex});c("  push: "+JSON.stringify(b));break;
case "endif":case "else":case "elif":a.b.lastIndex=b.index;if((d=a.b.exec(this.source))===j)throw Error("Illegal #"+b[2]+": "+this.source.substring(b.index,b.index+this.c)+"...");if(0==g.length)throw Error("Unexpected #"+d[1]+": "+this.source.substring(b.index,b.index+this.c)+"...");f=g.pop();c("  pop: "+JSON.stringify(f));e=this.source.substring(f.lastIndex,b.index);f.include?(c("  incl: "+a.nlToStr(e)+", 0-"+f.index+" + "+e.length+" bytes + "+a.b.lastIndex+"-"+this.source.length),this.source=this.source.substring(0,
f.index)+e+this.source.substring(a.b.lastIndex)):(c("  excl: "+a.nlToStr(e)+", 0-"+f.index+" + "+a.b.lastIndex+"-"+this.source.length),e="",this.source=this.source.substring(0,f.index)+this.source.substring(a.b.lastIndex));""==this.source&&c("  result empty");a.a.lastIndex=f.index+e.length;c("  continue at "+a.a.lastIndex);if("else"==d[1]||"elif"==d[1])e="else"==d[1]?!f.include:a.evaluate(h,d[2]),g.push(b={include:!f.include,index:a.a.lastIndex,lastIndex:a.a.lastIndex}),c("  push: "+JSON.stringify(b))}}0<
g.length&&(f=g.pop(),c("Still on stack: "+JSON.stringify(f)));return this.source};a.prototype.toString=function(){return"Preprocessor"};"undefined"!=typeof module&&module.exports?module.exports=a:"undefined"!=typeof define&&define.amd?define("Preprocessor",[],function(){return a}):(k.dcodeIO||(k.dcodeIO={}),k.dcodeIO.Preprocessor=a)})(this);
