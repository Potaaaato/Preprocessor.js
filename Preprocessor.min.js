/*
 Preprocessor.js (c) 2013 Daniel Wirtz <dcode@dcode.io>
 Released under the Apache License, Version 2.0
 see: https://github.com/dcodeIO/Preprocessor.js for details
*/
(function(l){function a(a,c){this.source=""+a;this.baseDir="string"==typeof c?c:".";this.h="object"==typeof c?c:{};this.isNode=("undefined"==typeof window||!window.window)&&"function"==typeof require;this.errorSourceAhead=50;this.c=[]}a.a=/([ ]*)\/\/[ ]+#(include|require|ifn?def|if|endif|else|elif|put|define)/g;a.f=/(include|require)[ ]+"([^"\\]*(\\.[^"\\]*)*)"[ ]*\r?(?:\n|$)/g;a.e=/(ifdef|ifndef|if)[ ]*([^\r\n]+)\r?\n/g;a.b=/(endif|else|elif)([ ]+[^\r\n]+)?\r?(?:\n|$)/g;a.g=/put[ ]+([^\n]+)[ ]*/g;
a.d=/define[ ]+([^\n]+)\r?(?:\n|$)/g;a.stripSlashes=function(a){return(a+"").replace(/\\(.?)/g,function(a,b){switch(b){case "\\":return"\\";case "0":return"\x00";case "":return"";default:return b}})};a.addSlashes=function(a){return(a+"").replace(/([\\"'])/g,"\\$1").replace(/\0/g,"\\0")};a.indent=function(a,c){for(var b=a.split("\n"),d=0;d<b.length;d++)b[d]=c+b[d];return b.join("\n")};a.nlToStr=function(a){return"["+a.replace(/\r/g,"").replace(/\n/g,"\\n")+"]"};a.evaluate=function(h,c,b){"string"===
typeof c&&(b=c,c=[]);var d=a.addSlashes;return function(a,b,c){for(var g in a)a.hasOwnProperty(g)&&eval("var "+g+' = "'+d(""+a[g])+'";');for(a=0;a<b.length;a++)g=b[a],"function "!=g.substring(0,9)&&"var "!=g.substring(0,4)&&(g="var "+g),eval(g);return eval(c)}.call(null,h,c,b)};a.prototype.process=function(h,c){h=h||{};c="function"==typeof c?c:function(){};c("Defines: "+JSON.stringify(h));for(var b,d,e,k=[];null!==(b=a.a.exec(this.source));){c(b[2]+" @ "+b.index+"-"+a.a.lastIndex);var f=b[1];switch(b[2]){case "include":case "require":a.f.lastIndex=
b.index;if(null===(d=a.f.exec(this.source)))throw Error("Illegal #"+b[2]+": "+this.source.substring(b.index,b.index+this.errorSourceAhead)+"...");e=a.stripSlashes(d[2]);c("  incl: "+e);if("undefined"!=typeof this.h[e])"require"==d[1]?(c("  Required filed already included: "+this.baseDir+"/"+e),e=""):e=this.h[e];else{if(!this.isNode)throw Error("Failed to resolve include: "+this.baseDir+"/"+e);try{d=e,e=require("fs").readFileSync(this.baseDir+"/"+e)+"",this.h[d]=e}catch(g){throw Error("File not found: "+
e+" ("+g+")");}}this.source=this.source.substring(0,b.index)+a.indent(e,f)+this.source.substring(a.f.lastIndex);a.a.lastIndex=0<k.length?k[k.length-1].lastIndex:0;c("  continue at "+a.a.lastIndex);break;case "put":a.g.lastIndex=b.index;if(null===(d=a.g.exec(this.source)))throw Error("Illegal #"+b[2]+": "+this.source.substring(b.index,b.index+this.errorSourceAhead)+"...");e=d[1];c("  expr: "+d[1]);e=a.evaluate(h,this.c,d[1]);c("  value: "+a.nlToStr(e));this.source=this.source.substring(0,b.index)+
f+e+this.source.substring(a.g.lastIndex);a.a.lastIndex=b.index+e.length;c("  continue at "+a.a.lastIndex);break;case "ifdef":case "ifndef":case "if":a.e.lastIndex=b.index;if(null===(d=a.e.exec(this.source)))throw Error("Illegal #"+b[2]+": "+this.source.substring(b.index,b.index+this.errorSourceAhead)+"...");c("  test: "+d[2]);e="ifdef"==d[1]?!!h[d[2]]:"ifndef"==d[1]?!h[d[2]]:a.evaluate(h,this.c,d[2]);c("  value: "+e);k.push(b={include:e,index:b.index,lastIndex:a.e.lastIndex});c("  push: "+JSON.stringify(b));
break;case "endif":case "else":case "elif":a.b.lastIndex=b.index;if(null===(d=a.b.exec(this.source)))throw Error("Illegal #"+b[2]+": "+this.source.substring(b.index,b.index+this.errorSourceAhead)+"...");if(0==k.length)throw Error("Unexpected #"+d[1]+": "+this.source.substring(b.index,b.index+this.errorSourceAhead)+"...");f=k.pop();c("  pop: "+JSON.stringify(f));e=this.source.substring(f.lastIndex,b.index);f.include?(c("  incl: "+a.nlToStr(e)+", 0-"+f.index+" + "+e.length+" bytes + "+a.b.lastIndex+
"-"+this.source.length),this.source=this.source.substring(0,f.index)+e+this.source.substring(a.b.lastIndex)):(c("  excl: "+a.nlToStr(e)+", 0-"+f.index+" + "+a.b.lastIndex+"-"+this.source.length),e="",this.source=this.source.substring(0,f.index)+this.source.substring(a.b.lastIndex));""==this.source&&c("  result empty");a.a.lastIndex=f.index+e.length;c("  continue at "+a.a.lastIndex);if("else"==d[1]||"elif"==d[1])e="else"==d[1]?!f.include:a.evaluate(h,this.c,d[2]),k.push(b={include:!f.include,index:a.a.lastIndex,
lastIndex:a.a.lastIndex}),c("  push: "+JSON.stringify(b));break;case "define":a.d.lastIndex=b.index;if(null===(d=a.d.exec(this.source)))throw Error("Illegal #"+b[2]+": "+this.source.substring(b.index,b.index+this.errorSourceAhead)+"...");e=d[1];c("  def: "+d[1]);this.c.push(e);this.source=this.source.substring(0,b.index)+f+this.source.substring(a.d.lastIndex);a.a.lastIndex=b.index;c("  continue at "+a.a.lastIndex)}}0<k.length&&(f=k.pop(),c("Still on stack: "+JSON.stringify(f)));return this.source};
a.prototype.toString=function(){return"Preprocessor"};"undefined"!=typeof module&&module.exports?module.exports=a:"undefined"!=typeof define&&define.amd?define("Preprocessor",[],function(){return a}):(l.dcodeIO||(l.dcodeIO={}),l.dcodeIO.Preprocessor=a)})(this);
